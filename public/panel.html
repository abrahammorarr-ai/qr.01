<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Cupones</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  margin:0;
  height:100vh;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:Arial, sans-serif;
  color:white;
}
.card{
  width:100%;
  max-width:440px;
  background:#1e1e1e;
  padding:30px 20px;
  border-radius:18px;
  text-align:center;
}
h2{ margin-bottom:15px; }
input{
  width:100%;
  padding:16px;
  font-size:20px;
  border-radius:10px;
  border:none;
  margin-bottom:12px;
  text-align:center;
}
button{
  width:100%;
  height:65px;
  font-size:22px;
  font-weight:bold;
  border:none;
  border-radius:14px;
  margin-top:10px;
}
.crear{ background:#2196f3; color:white; }
.buscar{ background:#4caf50; color:black; }
.eliminar{
  background:#e53935;
  color:white;
  height:45px;
  font-size:16px;
  margin-top:10px;
}
img{ margin-top:15px; width:240px; }
.cupon{
  background:#111;
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}
.stats{
  margin-top:25px;
  background:#000;
  padding:15px;
  border-radius:12px;
  text-align:left;
  font-size:18px;
}
.ok{ color:#4caf50; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h2>üéü Panel Cupones</h2>

  <!-- CREAR -->
  <input id="tel" placeholder="WhatsApp (opcional)">
  <input id="rut" placeholder="RUT cliente (opcional)">
  <button class="crear" onclick="crear()">GENERAR CUP√ìN</button>
  <div id="out"></div>

  <!-- STATS -->
  <div class="stats" id="stats">Cargando estad√≠sticas...</div>

  <hr style="margin:25px 0;opacity:.3">

  <!-- BUSCAR -->
  <input id="buscarRut" placeholder="Buscar por RUT">
  <button class="buscar" onclick="buscar()">BUSCAR CUPONES</button>
  <div id="lista"></div>
</div>

<script>
async function crear(){
  const res = await fetch("/crear",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      telefono: tel.value,
      rut: rut.value
    })
  });

  const c = await res.json();

  if(!res.ok){
    out.innerHTML = `<p style="color:red">${c.error}</p>`;
    return;
  }

  out.innerHTML = `
    <p>QR generado</p>
    <img src="${c.qr}">
  `;

  tel.value="";
  rut.value="";
  cargarStats();
}

async function cargarStats(){
  const r = await fetch("/stats");
  const s = await r.json();
  stats.innerHTML = `
    <p><b>üìä Resumen de hoy</b></p>
    <p>üéü Creados hoy: <span class="ok">${s.hoy}</span></p>
    <p>‚úÖ Canjeados hoy: <span class="ok">${s.usadosHoy}</span></p>
    <p>üì¶ Total hist√≥rico: <b>${s.total}</b></p>
  `;
}

async function buscar(){
  const r = buscarRut.value.trim();
  if(!r) return;

  const res = await fetch("/buscar/" + r);
  const listaCupones = await res.json();
  lista.innerHTML = "";

  if(listaCupones.length === 0){
    lista.innerHTML = "<p>No hay cupones</p>";
    return;
  }

  listaCupones.forEach(c=>{
    lista.innerHTML += `
      <div class="cupon">
        <p>üìÖ ${c.fecha}</p>
        <p>${c.usado ? "‚ùå Usado" : "‚úÖ Activo"}</p>
        <button class="eliminar" onclick="eliminar('${c.id}')">
          üóë ELIMINAR
        </button>
      </div>
    `;
  });
}

async function eliminar(id){
  const seguro = confirm("‚ö†Ô∏è ¬øEliminar este cup√≥n?\n\nEsta acci√≥n NO se puede deshacer");
  if(!seguro) return;

  const res = await fetch("/eliminar/" + id, { method:"DELETE" });
  if(res.ok){
    alert("Cup√≥n eliminado");
    buscar();
    cargarStats();
  }else{
    alert("Error al eliminar");
  }
}

cargarStats();
</script>

</body>
</html>


